---
title: "Untitled"
author: "girl squad"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: cosmo
    toc_float: yes
    code_folding: hide
    number_sections: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(sf)
library(stats)
library(tidycensus)
library(tidyr)
library(tigris)

```

```{r geography, include=FALS, message=FALSE, warning=FALSE}

options(tigris_use_cache = TRUE)

md_bound <- counties(state = "MD") %>%
  st_transform("EPSG:4269") %>%
  erase_water(area_threshold = 0.9)

water_bound <- st_as_sfc(st_bbox(md_bound), crs = "EPSG:4269")

```

```{r genindex_data, warning=FALSE, message=FALSE}

#Calculate 80% of median household income for 2012
bmore_hhinc12 <- get_acs(
  geography = "tract", 
  variables = "B19013_001",
  state = "MD", 
  county = "Baltimore City",
  year = 2012,
  geometry = TRUE 
) %>%
  select(GEOID, estimate) %>%
  rename(est12 = estimate)

bmore_80medhhinc12 <- bmore_hhinc12 %>%
  na.omit() %>%
  summarise(med12 = median(est12)) %>%
  st_drop_geometry()

bmore_80medhhinc12 <- bmore_80medhhinc12[[1,1]]
bmore_80medhhinc12 = (bmore_80medhhinc12 * .80)

#Calculate 80% of median household income for 2022
bmore_hhinc22 <- get_acs(
  geography = "tract", 
  variables = "B19013_001",
  state = "MD", 
  county = "Baltimore City",
  year = 2022,
  geometry = FALSE 
) %>%
  select(GEOID, estimate) %>%
  rename(est22 = estimate)

bmore_80medhhinc22 <- bmore_hhinc22 %>%
  na.omit() %>%
  summarise(med12 = median(est22)) %>%
  st_drop_geometry()

bmore_80medhhinc22 <- bmore_80medhhinc22[[1,1]]
bmore_80medhhinc22 = (bmore_80medhhinc22 * .80)

#Determine proportion of the population per ct that is Low and High income
acsvar22 <- load_variables(2022, "acs5", cache = TRUE)

bmore_ctmedhhinc12 <- get_acs(
  geography = "tract", 
  variables = c(tot = "B19001_001", 
                L = "B19001_002", L = "B19001_003", L = "B19001_004", L = "B19001_005", L = "B19001_006",
                H = "B19001_007", H = "B19001_008", H = "B19001_009", H = "B19001_010", H = "B19001_011", 
                H = "B19001_012", H = "B19001_013", H = "B19001_014", H = "B19001_015", H = "B19001_016", 
                H = "B19001_017"),
  state = "MD", 
  county = "Baltimore City",
  year = 2012,
  geometry = FALSE 
) %>%
  select(GEOID, variable, estimate) %>%
  rename(est12 = estimate, var12 = variable) %>%
  group_by(GEOID, var12) %>%
  summarise(est12 = sum(est12)) %>%
  pivot_wider(names_from = var12, values_from = est12) %>%
  mutate(pH12 = H/tot, pL12 = L/tot)

bmore_ctmedhhinc22 <- get_acs(
  geography = "tract", 
  variables = c(tot = "B19001_001", 
                L = "B19001_002", L = "B19001_003", L = "B19001_004", L = "B19001_005", L = "B19001_006",
                L = "B19001_007", L = "B19001_008", L = "B19001_009", H = "B19001_010", H = "B19001_011", 
                H = "B19001_012", H = "B19001_013", H = "B19001_014", H = "B19001_015", H = "B19001_016", 
                H = "B19001_017"),
  state = "MD", 
  county = "Baltimore City",
  year = 2022,
  geometry = FALSE 
) %>%
  select(GEOID, variable, estimate) %>%
  rename(est22 = estimate, var22 = variable) %>%
  group_by(GEOID, var22) %>%
  summarise(est22 = sum(est22)) %>%
  pivot_wider(names_from = var22, values_from = est22) %>%
  mutate(pH22 = H/tot, pL22 = L/tot)

#Calculate gentrification index
bmore_genindex <- left_join(bmore_ctmedhhinc12, bmore_ctmedhhinc22, by = "GEOID") %>%
  select(GEOID, pH12, pH22, pL12, pL22) %>%
  mutate(genindex = (pH22 - pH12) - (pL22 - pL12))

#Label CT based on whether they have or have not gentrified
bmore_genindex <- bmore_genindex %>%
  mutate(normal = (genindex + 1)/2) %>%
  mutate(gent = case_when(normal >= (quantile(bmore_genindex$normal, probs = c(0.75), na.rm = TRUE)) ~ "Gentrified", TRUE ~ 'Not Gentrified'))

#Check for proportion of residents who moved in prior to 2012?


```

```{r genindex_map, warning=FALSE, message=FALSE}

#Attach geometry to the index
bmore_ctgeo <- get_acs(
  geography = "tract", 
  variables = "B19001_001",
  state = "MD", 
  county = "Baltimore City",
  year = 2022,
  geometry = TRUE 
) %>%
  select(GEOID) %>%
  st_transform("EPSG:4269")

bmore_genindex_sf <- left_join(bmore_ctgeo, bmore_genindex, by = "GEOID")

#Map
ggplot() +
  geom_sf(data = water_bound, fill = "steelblue") +
  geom_sf(data = md_bound, fill = "gray80", col = "gray75") +
  geom_sf(data = bmore_genindex_sf, aes(fill = genindex), col = "transparent") +
  scale_fill_gradient(
    high = "orangered4",
    low = "lightgoldenrod1") +
  theme_void() +
  xlim(-76.75, -76.48) +
  ylim(39.2, 39.38) +
  theme(legend.position = "bottom", legend.key.width = unit(1.5, "cm")) +
  labs(fill = "Gentrification Index",
       title = "2022 Gentrification Index",
       subtitle = "Baltimore City, MD")

#"firebrick4", "darkgoldenrod", "darkolivegreen", "royalblue4", "mediumpurple4"

```
