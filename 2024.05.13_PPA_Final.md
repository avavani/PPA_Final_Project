---
title: "Predicting Gentrification"
author: "PPA Spring 2024 Final - Contributors: Avani, Christina, & Sarah"
date: "2024-05-13"
output:
  html_document:
    keep_md: yes
    toc: yes
    theme: cosmo
    toc_float: yes
    code_folding: hide
    number_sections: no
  pdf_document:
    toc: yes
---

# Abstract

Defining and predicting gentrification is becoming more and more relevant to the average person as neighborhood residents become more concerned about getting priced out of their communities. Once something that could only be observed in hindsight, anticipating gentrification and attempting to prevent its disparate effects has become the subject of activism and counter-lobbying efforts. This report attempts to determine if gentrification can be correctly identified in Baltimore City, Maryland based on neighborhood characteristics that the average person can observe.







# About Baltimore City

Baltimore City, Maryland sits on the Patapsco River and is home to over 585,000 people (2020 Census). An incredibly historic city, though Baltimore was once full of rigorous industry, unbridled American patriotism, and wealth, its late 20th century reality was plagued by extreme disinvestment, high crime, and white flight.

::: {style="display: flex;"}

::: {}



![](2024.05.13_PPA_Final_files/figure-html/bmorevis_mapcol1-1.png)<!-- -->![](2024.05.13_PPA_Final_files/figure-html/bmorevis_mapcol1-2.png)<!-- -->

:::

::: {}

![](2024.05.13_PPA_Final_files/figure-html/bmorevis_mapcol2-1.png)<!-- -->![](2024.05.13_PPA_Final_files/figure-html/bmorevis_mapcol2-2.png)<!-- -->

:::

::::

Baltimore is less than an hour North of Annapolis, MD (the state capital) and Washington, DC as the crow drives. Baltimore/Washington International Airport (BWI) does not lie within Baltimore City boundaries.

# Defining Gentrification

We define our Gentrification Index per CT as follows:

GI = (∆ Low Income Proportion) + (Percent Change of Rent) + (Percent Change of Home Value)

The change is calculated by subtracting the 2012 values from the 2022 values. If the change in proportion of high income residents is below 1, and the change in proportion of low income residents is above 1, then the equation would result in a negative number and would indicate that more poor residents have “moved” in - and would not indicate the occurrence of gentrification. If the change in proportion of high income residents is above 1, and the change in proportion of low income residents is below 1, then the equation would result in a positive number and would indicate that more wealthy residents have “moved” in - a key indicator of gentrification.


```r
#Getting population by Income numbers
bmore_ctmedhhinc12 <- get_acs(
  geography = "tract", 
  variables = c(tot = "B19001_001", 
                L = "B19001_002", L = "B19001_003", L = "B19001_004", L = "B19001_005", L = "B19001_006",
                H = "B19001_007", H = "B19001_008", H = "B19001_009", H = "B19001_010", H = "B19001_011", 
                H = "B19001_012", H = "B19001_013", H = "B19001_014", H = "B19001_015", H = "B19001_016", 
                H = "B19001_017"),
  state = "MD", 
  county = "Baltimore City",
  year = 2012,
  geometry = FALSE 
) %>%
  select(GEOID, variable, estimate) %>%
  rename(est12 = estimate, var12 = variable) %>%
  group_by(GEOID, var12) %>%
  summarise(est12 = sum(est12)) %>%
  pivot_wider(names_from = var12, values_from = est12) %>%
  mutate(percentHighInc12 = H/tot, percentLowInc12 = L/tot)

#adjusting for joined census tracts
changed_22Inc <- bmore_ctmedhhinc12 %>%
  filter(GEOID %in% c("24510180100", "24510180200")) %>%
  ungroup() %>%
  summarize(H = sum(H), L = sum(L), tot = sum(tot)) %>%
  mutate(percentHighInc12 = H / tot,
         percentLowInc12 = L / tot) %>%
  mutate(GEOID = "24510280600")

#joining info back to 2012
bmore_ctmedhhinc12 <- bmore_ctmedhhinc12 %>%
  ungroup()%>%
  filter(!(GEOID %in% c("24510180100", "24510180200"))) %>%
  bind_rows(changed_22Inc)

#getting HH income for 2022
bmore_ctmedhhinc22 <- get_acs(
  geography = "tract", 
  variables = c(tot = "B19001_001", 
                L = "B19001_002", L = "B19001_003", L = "B19001_004", L = "B19001_005", L = "B19001_006",
                L = "B19001_007", L = "B19001_008", L = "B19001_009", H = "B19001_010", H = "B19001_011", 
                H = "B19001_012", H = "B19001_013", H = "B19001_014", H = "B19001_015", H = "B19001_016", 
                H = "B19001_017"),
  state = "MD", 
  county = "Baltimore City",
  year = 2022,
  geometry = FALSE 
) %>%
  select(GEOID, variable, estimate) %>%
  rename(est22 = estimate, var22 = variable) %>%
  group_by(GEOID, var22) %>%
  summarise(est22 = sum(est22)) %>%
  pivot_wider(names_from = var22, values_from = est22) %>%
  mutate(percentHighInc22 = H/tot, percentLowInc22 = L/tot)
```






```r
all.acs.sf.g <- all.acs.sf %>%
  dplyr::select(GEOID, gentrify) %>%
  mutate(gentrify = as.factor(gentrify))

ggplot() +
  geom_sf(data = water_bound, fill = "steelblue") +
  geom_sf(data = md_bound, fill = "gray80", col = "gray75") +
  geom_sf(data = all.acs.sf, aes(fill = as.factor(gentrify)), col = "#756059") +
  scale_fill_manual(values = c("#5FA08F", "#F56A40"),
                    labels = c("No", "Yes")) +
  geom_sf(data = patapsco, fill = "steelblue", col = "transparent") +
  theme_void() +
  xlim(-76.75, -76.48) +
  ylim(39.2, 39.38) +
  theme(legend.position = "bottom", legend.key.width = unit(1.5, "cm")) +
  labs(fill = "Gentrified?",
       title = "2022 Gentrification per Census Tract",
       subtitle = "Baltimore City, MD")
```

![](2024.05.13_PPA_Final_files/figure-html/gentrification_map-1.png)<!-- -->


# Data Collection

For testing the ability to predict gentrification, input features that could be observed by eye were sourced, cleaned, and used in the model. Our data sources primarily included the 2012 and 2022 5-year ACS (American Community Survey) from the U.S. Census Bureau and Open Baltimore (<https://data.baltimorecity.gov/>).

The specific features pulled based on this criteria were:

_Baltimore City Open Bid List_
The Baltimore Bids feature includes city owned vacant lots and properties with vacant building notices. 

_Universities and Colleges_ 
The colleges feature includes the locations of universities and colleges in Baltimore. 

_Businesses_ 
The businesses feature contains the count of businesses in each community statistical area (CSA), which is a geographic measurement developed by the Baltimore City Planning Department to define neighborhood clusters. Ths model also includes a change in businesses feature, which accounts for the change in count of businesses per CSA from 2010 to 2019. 

_Vacant Lots_ 
The vacant lots feature includes the percentage of vacant lots per CSA. 

_Baltimore Schools_ 
The schools feature highlights the percentage of students per CSA who exceeded or met the Partnership for Assessment of Readiness for College and Careers (PARCC) math expectations. 

_Walk Score_
The walk score feature includes the average walk score by CSA and the change in walk score from 2017 to 2011.




```r
#change in walk score
ggplot() +
  geom_sf(data = water_bound, fill = "steelblue") +
  geom_sf(data = md_bound, fill = "gray80", col = "gray75") +
  geom_sf(data = walk_score_csa, aes(fill = changewalk), col = "transparent") +
  scale_fill_gradient(
    high = "#861D05",
    low = "#F5B5AC") +
  geom_sf(data = patapsco, fill = "steelblue", col = "transparent") +
  theme_void() +
  xlim(-76.75, -76.48) +
  ylim(39.2, 39.38) +
  theme(legend.position = "bottom", legend.key.width = unit(1.5, "cm")) +
  labs(fill = "Change in Walk Score",
       title = "2011 to 2017 Change in Walk Score",
       subtitle = "Baltimore City, MD")
```

![](2024.05.13_PPA_Final_files/figure-html/feature_mapcol1-1.png)<!-- -->

```r
#percent change in hosuing units
huchange <- all.acs.sf %>%
  dplyr::select(HUnitsPctChange, GEOID) %>%
  dplyr::mutate(HUnitsPctChange = HUnitsPctChange/100)

ggplot() +
  geom_sf(data = water_bound, fill = "steelblue") +
  geom_sf(data = md_bound, fill = "gray80", col = "gray75") +
  geom_sf(data = huchange, aes(fill = HUnitsPctChange), col = "transparent") +
  scale_fill_gradient(
    high = "#864259",
    low = "#F5A6C3", 
    labels = scales::percent) +
  geom_sf(data = patapsco, fill = "steelblue", col = "transparent") +
  theme_void() +
  xlim(-76.75, -76.48) +
  ylim(39.2, 39.38) +
  theme(legend.position = "bottom", legend.key.width = unit(1.5, "cm")) +
  labs(fill = "Percent Change of Housing Units",
       title = "2017 to 2022 Percent Change in Housing Units",
       subtitle = "Baltimore City, MD")
```

![](2024.05.13_PPA_Final_files/figure-html/feature_mapcol1-2.png)<!-- -->

## Joining additional metrics


```r
p_load(nngeo,FNN,tibble, caret)

bmore_hoods <- bmore_p_lots %>%
  select(-p_vacant)

bmore_CSA_data <- bmore_p_lots %>%
  st_drop_geometry()%>%
  left_join(bmore_business)%>%
  st_as_sf()

bmore_CSA_data <- st_join(bmore_CSA_data, school_outcome, left = TRUE)%>%
  mutate(CSA = coalesce(CSA.x, CSA.y)) %>%
  select(-CSA.x, -CSA.y)%>%
mutate(across(everything(), ~replace_na(., 0)))

bmore_CSA_data <- st_join(bmore_CSA_data, walk_score, left = TRUE)%>%
  mutate(CSA = coalesce(CSA.x, CSA.y)) %>%
  select(-CSA.x, -CSA.y)%>%
mutate(across(everything(), ~replace_na(., 0)))

coldist <- baltimore_tracts
coldist$nearest_college_index <- st_nearest_feature(coldist, bmore_colleges)
coldist <- coldist %>%
  rowwise() %>%
  mutate(nearest_college = list(bmore_colleges[nearest_college_index, ]))
coldist <- coldist %>%
  mutate(coldist = st_distance(geometry, nearest_college$geometry))%>%
  select(-nearest_college_index,
         -nearest_college)%>%
  rename(collegedist = coldist)%>%
  st_drop_geometry()

acs.hoods <- all.acs.sf %>%
  st_transform(crs = st_crs(bmore_CSA_data))%>%
  st_centroid()%>%
  st_join(bmore_CSA_data, join = st_intersects)%>%
  mutate(NAME = coalesce(NAME.x, NAME.y)) %>%
  select(-NAME.x, -NAME.y)

acs.hoods <- acs.hoods %>%
  left_join(coldist)

acs.hoods <- acs.hoods %>%
  select(-STATEFP,
         -COUNTYFP,
         -TRACTCE,
         -NAMELSAD,
         -MTFCC,
         -FUNCSTAT,
         -ALAND,
         -AWATER,
         -INTPTLAT,
         -INTPTLON,
         -NAME) %>%
  st_drop_geometry()%>%
  left_join(bmore_bids)%>%
  mutate(across(where(is.numeric), ~replace_na(., 0)),
         across(where(is.character), ~replace_na(., "Unknown")))
```

# Model Development & Testing


```r
p_load(stargazer)

all.acs.reg <- acs.hoods 
all.acs.reg <- all.acs.reg %>%
  select(-(ends_with("22")),
         -(ends_with("12")),
         -genindex,
         -CSA,
         -RentPctChange,
         -HomeValuePctChange,
         -MedianRent17,
         -MedianHouseholdIncome17,
         -MedianRent22,
-BachelorsDegree17,
         -MedianHouseholdIncome22,
         -MedianHomeValue22,
         -MedianHouseholdIncome22,
         -percentHighInc22,
         -percentHighInc12,
         -WhiteAlone17,
         -GradProfessionalDegree17,
         -MovedAbroad17,
         -OwnerOccupiedHouseholdSize17,
         -RenterOccupiedSize17,
         -MedianHomeValue17,
-SStateMovePct17,
-DiffStateMovePct17,
-WhiteAlonePct17,
-AbroadMovePct17,
-BachelorsPct17,
         -inflation.adjHH17,
         -FamilyHouseholds17,
         -NonFamilyHouseholds17,
-VacantUnitsPctChange)%>%
mutate(walk_school = p_students * walk_score)%>%
mutate(business2 = changebiz ^2)%>%
select(-p_students,
-walk_score,
-changebiz,
-business_count)

train <- all.acs.reg %>%
  sample_frac(.75)

train_index <- as.numeric(rownames(train))

test <- all.acs.reg[-train_index, ]

reg.gentrify <- glm(gentrify ~ ., data = 
                    train %>%
                      select(-GEOID,
                             -ChangeInLowIncPct,
                             -ChangeInHighIncPct),
                    family = "binomial"(link = "logit"))

stargazer(reg.gentrify, type = "text", out = "regression_summary.txt", title = "Regression Results", 
          label = "tab:regression_results", align = TRUE, 
          ci = TRUE, ci.level = 0.95, single.row = TRUE, 
          star.cutoffs = c(0.05, 0.01, 0.001), 
          notes = c("*** p<0.001", "** p<0.01", "* p<0.05"), 
          notes.align = "l", notes.label = "Significance levels:")
```

```
## 
## Regression Results
## =======================================================
##                                Dependent variable:     
##                           -----------------------------
##                                     gentrify           
## -------------------------------------------------------
## TotalPopulation17            0.001 (-0.0005, 0.002)    
## TotalHousingUnits17          -0.001 (-0.003, 0.002)    
## VacantHousingUnits17         -0.0004 (-0.006, 0.005)   
## MovedWithinCounty17          -0.005 (-0.013, 0.004)    
## MovedFromSameState17         -0.006 (-0.013, 0.0003)   
## MovedFromDifferentState17    -0.004 (-0.013, 0.005)    
## PopChangePct                 -0.026 (-0.086, 0.035)    
## HUnitsPctChange              0.128** (0.042, 0.214)    
## IncPctChange                  0.015 (-0.006, 0.035)    
## GradPct17                    -0.019 (-0.115, 0.078)    
## CountyWWMovePct17             0.227 (-0.029, 0.483)    
## WhiteAlonePctChange         -0.00000 (-0.001, 0.001)   
## GradPctChange                 0.001 (-0.001, 0.003)    
## CountyWWMovePctChange         0.002 (-0.008, 0.013)    
## SStateMovePctChange          0.0003 (-0.001, 0.001)    
## DiffStateMovePctChange       0.0001 (-0.002, 0.002)    
## AbroadMovePctChange           0.001 (-0.002, 0.003)    
## BachelorsPctChange           -0.001 (-0.008, 0.006)    
## OOSizePctChange               0.033 (-0.006, 0.073)    
## ROSizePctChange               0.031 (-0.005, 0.066)    
## FamHHPctChange               -0.023 (-0.058, 0.012)    
## NonFamHHPctChange            -0.014 (-0.044, 0.015)    
## p_vacant                      0.038 (-0.059, 0.135)    
## changewalk                   -0.044 (-0.177, 0.089)    
## collegedist                 0.00003 (-0.0005, 0.001)   
## tractbids                    -0.016 (-0.067, 0.036)    
## walk_school                  -0.0001 (-0.001, 0.001)   
## business2                  -0.00002 (-0.0001, 0.0001)  
## Constant                     -1.942 (-4.969, 1.086)    
## -------------------------------------------------------
## Observations                           149             
## Log Likelihood                       -63.923           
## Akaike Inf. Crit.                    185.846           
## =======================================================
## Significance levels:      *p<0.05; **p<0.01; ***p<0.001
##                           *** p<0.001                  
##                           ** p<0.01                    
##                           * p<0.05
```

Testing the outcomes.


```r
testProbs <- 
  data.frame(class = test$gentrify,
             probs = predict(reg.gentrify, test, type = "response"))

testProbs %>%
  mutate(predClass = ifelse(probs >= .5, "1", "0"), 
         predClass = factor(predClass, levels = c("0", "1")),  
         class = factor(class, levels = c("0", "1"))) %>% 
  { caret::confusionMatrix(.$predClass, .$class, positive = "1") }
```

```
## Confusion Matrix and Statistics
## 
##           Reference
## Prediction  0  1
##          0 31  7
##          1  6  6
##                                           
##                Accuracy : 0.74            
##                  95% CI : (0.5966, 0.8537)
##     No Information Rate : 0.74            
##     P-Value [Acc > NIR] : 0.5739          
##                                           
##                   Kappa : 0.307           
##                                           
##  Mcnemar's Test P-Value : 1.0000          
##                                           
##             Sensitivity : 0.4615          
##             Specificity : 0.8378          
##          Pos Pred Value : 0.5000          
##          Neg Pred Value : 0.8158          
##              Prevalence : 0.2600          
##          Detection Rate : 0.1200          
##    Detection Prevalence : 0.2400          
##       Balanced Accuracy : 0.6497          
##                                           
##        'Positive' Class : 1               
## 
```

More stuff


```r
p_load(ggplot2)
palette_4_colors <- c("#e4572e","#17bebb","#ffc914","#A379C9")
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

ggplot(testProbs, aes(x = probs, fill = as.factor(class))) + 
  geom_density() +
  facet_grid(class ~ .) +
  scale_fill_manual(values = palette_4_colors) + xlim(0, 1) +
  labs(x = "Gentrify", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome") +
  plotTheme() + theme(strip.text.x = element_text(size = 18),
        legend.position = "none")+
  theme(text = element_text(family = "Times New Roman", size = 12), 
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(size = 8))
```

![](2024.05.13_PPA_Final_files/figure-html/probdist-1.png)<!-- -->

# Validation

More of the stuff. This time calling up a ROC curve.


```r
p_load(pROC)

iterateThresholds <- function(data, observedClass, predictedProbs) {
  observedClass <- enquo(observedClass)
  predictedProbs <- enquo(predictedProbs)
  
  x <- 0.01
  all_prediction <- data.frame()
  
  while (x <= 1) {
    this_prediction <- data %>%
      mutate(predclass = ifelse(!!predictedProbs > x, 1, 0)) %>%
      count(predclass, !!observedClass) %>%
      summarize(
        Count_TN = sum(n[predclass == 0 & !!observedClass == 0]),
        Count_TP = sum(n[predclass == 1 & !!observedClass == 1]),
        Count_FN = sum(n[predclass == 0 & !!observedClass == 1]),
        Count_FP = sum(n[predclass == 1 & !!observedClass == 0]),
        Rate_TP = Count_TP / (Count_TP + Count_FN),
        Rate_FP = Count_FP / (Count_FP + Count_TN),
        Rate_FN = Count_FN / (Count_FN + Count_TP),
        Rate_TN = Count_TN / (Count_TN + Count_FP),
        Accuracy = (Count_TP + Count_TN) / (Count_TP + Count_TN + Count_FN + Count_FP),
        Threshold = round(x, 2),
        .groups = 'drop'
      )
    
    all_prediction <- rbind(all_prediction, this_prediction)
    x <- x + .01
  }
  
  return(all_prediction)
}

testProbs.thresholds <- iterateThresholds(
  data = testProbs, 
  observedClass = class, 
  predictedProbs = probs
)

ggplot(testProbs.thresholds, aes(x = Threshold)) +
  geom_line(aes(y = Accuracy, color = "Accuracy")) +
  geom_line(aes(y = Rate_TP, color = "True Positive Rate")) +
  geom_line(aes(y = Rate_FP, color = "False Positive Rate")) +
  scale_color_manual(values = c("Accuracy" = "blue", "True Positive Rate" = "green", "False Positive Rate" = "red")) +
  labs(title = "Model Performance Across Different Thresholds",
       x = "Threshold", y = "Rate") +
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        text = element_text(family = "Times New Roman", size = 12),
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(size = 8))
```

![](2024.05.13_PPA_Final_files/figure-html/ROCcurve-1.png)<!-- -->

ROC curve



# Conclusion
